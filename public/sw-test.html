<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Service Worker - EMB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: white;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 36px;
            margin-bottom: 10px;
            color: #06b6d4;
        }

        .subtitle {
            color: #888;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.success {
            background: #10b981;
            color: white;
        }

        .status.error {
            background: #ef4444;
            color: white;
        }

        .status.warning {
            background: #f59e0b;
            color: white;
        }

        .status.info {
            background: #06b6d4;
            color: white;
        }

        button {
            background: #06b6d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        button:hover {
            background: #0891b2;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #888;
            margin-right: 10px;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-info {
            color: #06b6d4;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
        }

        .info-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
        }

        code {
            background: rgba(6, 182, 212, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Service Worker</h1>
        <p class="subtitle">V√©rification de l'√©tat et des fonctionnalit√©s du Service Worker EMB</p>

        <!-- √âtat du Service Worker -->
        <div class="card">
            <h2>üìä √âtat du Service Worker <span id="sw-status" class="status info">V√©rification...</span></h2>
            <div class="info-grid" id="sw-info"></div>
        </div>

        <!-- Capacit√©s PWA -->
        <div class="card">
            <h2>üöÄ Capacit√©s PWA</h2>
            <div class="info-grid" id="pwa-capabilities"></div>
        </div>

        <!-- Actions de test -->
        <div class="card">
            <h2>üß™ Actions de test</h2>
            <button onclick="testCache()">üì¶ Tester le cache</button>
            <button onclick="testOffline()">üîå Simuler mode hors ligne</button>
            <button onclick="updateSW()">üîÑ Forcer mise √† jour SW</button>
            <button onclick="clearCache()">üóëÔ∏è Vider le cache</button>
            <button onclick="unregisterSW()">‚ùå D√©sinscrire SW</button>
            <button onclick="testNotification()">üîî Tester notification</button>
            <button onclick="checkCacheContent()">üìã Voir contenu du cache</button>
        </div>

        <!-- Journal des tests -->
        <div class="card">
            <h2>üìù Journal des tests</h2>
            <div class="log" id="test-log"></div>
        </div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('test-log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[SW Test] ${message}`);
        };

        const updateStatus = (status, type = 'info') => {
            const statusEl = document.getElementById('sw-status');
            statusEl.textContent = status;
            statusEl.className = `status ${type}`;
        };

        const addInfo = (label, value, container = 'sw-info') => {
            const infoDiv = document.getElementById(container);
            const item = document.createElement('div');
            item.className = 'info-item';
            item.innerHTML = `
                <div class="info-label">${label}</div>
                <div class="info-value">${value}</div>
            `;
            infoDiv.appendChild(item);
        };

        // V√©rifier l'√©tat du Service Worker
        async function checkSWStatus() {
            if ('serviceWorker' in navigator) {
                log('‚úÖ Service Worker support√©', 'success');

                try {
                    const registration = await navigator.serviceWorker.getRegistration();

                    if (registration) {
                        log('‚úÖ Service Worker enregistr√©', 'success');
                        updateStatus('Actif', 'success');

                        // Informations sur le SW
                        addInfo('√âtat', registration.active ? 'Actif ‚úÖ' : 'Non actif ‚ö†Ô∏è');
                        addInfo('Scope', registration.scope);
                        addInfo('Mode de mise √† jour', registration.updateViaCache || 'imports');

                        if (registration.active) {
                            addInfo('Script URL', registration.active.scriptURL);
                            addInfo('√âtat du worker', registration.active.state);
                        }

                        if (registration.waiting) {
                            log('‚ö†Ô∏è Nouvelle version en attente', 'warning');
                            addInfo('En attente', 'Nouvelle version disponible ‚ö†Ô∏è');
                        }

                        if (registration.installing) {
                            log('‚è≥ Installation en cours...', 'info');
                        }

                        // V√©rifier le contr√¥leur
                        if (navigator.serviceWorker.controller) {
                            log('‚úÖ Page contr√¥l√©e par le Service Worker', 'success');
                            addInfo('Contr√¥leur', 'Page contr√¥l√©e ‚úÖ');
                        } else {
                            log('‚ö†Ô∏è Page non contr√¥l√©e (rechargez pour activer)', 'warning');
                            addInfo('Contr√¥leur', 'Non actif (recharger) ‚ö†Ô∏è');
                        }
                    } else {
                        log('‚ùå Service Worker non enregistr√©', 'error');
                        updateStatus('Non enregistr√©', 'error');
                    }
                } catch (error) {
                    log(`‚ùå Erreur: ${error.message}`, 'error');
                    updateStatus('Erreur', 'error');
                }
            } else {
                log('‚ùå Service Worker non support√© par ce navigateur', 'error');
                updateStatus('Non support√©', 'error');
            }
        }

        // V√©rifier les capacit√©s PWA
        function checkPWACapabilities() {
            addInfo('Service Worker', 'serviceWorker' in navigator ? '‚úÖ Support√©' : '‚ùå Non support√©', 'pwa-capabilities');
            addInfo('Cache API', 'caches' in window ? '‚úÖ Support√©' : '‚ùå Non support√©', 'pwa-capabilities');
            addInfo('Notifications', 'Notification' in window ? `‚úÖ ${Notification.permission}` : '‚ùå Non support√©', 'pwa-capabilities');
            addInfo('Background Sync', 'sync' in ServiceWorkerRegistration.prototype ? '‚úÖ Support√©' : '‚ùå Non support√©', 'pwa-capabilities');
            addInfo('Periodic Sync', 'periodicSync' in ServiceWorkerRegistration.prototype ? '‚úÖ Support√©' : '‚ùå Non support√©', 'pwa-capabilities');
            addInfo('Push API', 'PushManager' in window ? '‚úÖ Support√©' : '‚ùå Non support√©', 'pwa-capabilities');
        }

        // Tester le cache
        async function testCache() {
            try {
                log('üîç V√©rification du cache...', 'info');
                const cacheNames = await caches.keys();
                log(`‚úÖ ${cacheNames.length} cache(s) trouv√©(s): ${cacheNames.join(', ')}`, 'success');

                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const keys = await cache.keys();
                    log(`üì¶ ${cacheName}: ${keys.length} entr√©es`, 'info');
                }
            } catch (error) {
                log(`‚ùå Erreur lors de la v√©rification du cache: ${error.message}`, 'error');
            }
        }

        // Voir le contenu d√©taill√© du cache
        async function checkCacheContent() {
            try {
                log('üìã Lecture du contenu du cache...', 'info');
                const cacheNames = await caches.keys();

                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const requests = await cache.keys();

                    log(`\nüì¶ Cache: ${cacheName} (${requests.length} √©l√©ments)`, 'info');

                    requests.forEach((request, index) => {
                        log(`  ${index + 1}. ${request.url}`, 'info');
                    });
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // Simuler le mode hors ligne
        function testOffline() {
            log('üîå Pour tester le mode hors ligne:', 'info');
            log('1. Ouvrez DevTools (F12)', 'info');
            log('2. Allez dans l\'onglet Network', 'info');
            log('3. Cochez "Offline" dans la liste d√©roulante', 'info');
            log('4. Rechargez la page', 'info');
        }

        // Forcer la mise √† jour du SW
        async function updateSW() {
            try {
                log('üîÑ V√©rification de mise √† jour...', 'info');
                const registration = await navigator.serviceWorker.getRegistration();

                if (registration) {
                    await registration.update();
                    log('‚úÖ Mise √† jour v√©rifi√©e', 'success');
                } else {
                    log('‚ùå Aucun Service Worker enregistr√©', 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur de mise √† jour: ${error.message}`, 'error');
            }
        }

        // Vider le cache
        async function clearCache() {
            try {
                log('üóëÔ∏è Vidage du cache...', 'info');
                const cacheNames = await caches.keys();

                await Promise.all(
                    cacheNames.map(cacheName => caches.delete(cacheName))
                );

                log(`‚úÖ ${cacheNames.length} cache(s) supprim√©(s)`, 'success');
            } catch (error) {
                log(`‚ùå Erreur lors du vidage: ${error.message}`, 'error');
            }
        }

        // D√©sinscrire le SW
        async function unregisterSW() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir d√©sinscrire le Service Worker ?')) {
                try {
                    log('‚ùå D√©sinscription du Service Worker...', 'info');
                    const registration = await navigator.serviceWorker.getRegistration();

                    if (registration) {
                        await registration.unregister();
                        log('‚úÖ Service Worker d√©sinscrit', 'success');
                        log('üîÑ Rechargez la page pour r√©inscrire', 'info');
                    }
                } catch (error) {
                    log(`‚ùå Erreur: ${error.message}`, 'error');
                }
            }
        }

        // Tester les notifications
        async function testNotification() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    log('‚úÖ Permission accord√©e', 'success');

                    new Notification('Test EMB', {
                        body: 'Notification de test du Service Worker',
                        icon: '/logo.png',
                        badge: '/logo.png',
                        vibrate: [200, 100, 200]
                    });

                    log('üîî Notification envoy√©e', 'success');
                } else {
                    log('‚ùå Permission refus√©e', 'error');
                }
            } else {
                log('‚ùå Notifications non support√©es', 'error');
            }
        }

        // √âcouter les messages du SW
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data) {
                    log(`üì® Message du SW: ${JSON.stringify(event.data)}`, 'info');
                }
            });

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                log('üîÑ Nouveau contr√¥leur d√©tect√©', 'info');
            });
        }

        // Initialiser au chargement
        window.addEventListener('load', () => {
            log('üöÄ Test du Service Worker EMB d√©marr√©', 'info');
            checkSWStatus();
            checkPWACapabilities();
        });

        // V√©rifier p√©riodiquement l'√©tat
        setInterval(() => {
            if (navigator.serviceWorker.controller) {
                const event = new CustomEvent('sw-active');
                window.dispatchEvent(event);
            }
        }, 10000);
    </script>
</body>
</html>
